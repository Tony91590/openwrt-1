#!/bin/sh

uci set luci.main.lang=auto
uci commit luci

uci set system.@system[0].timezone='CET-1CEST,M3.5.0,M10.5.0/3'
uci set system.@system[0].zonename='Europe/Paris'
uci set system.led_wan.mode='link'
uci set system.led_lan.mode='link'
uci commit system

uci set fstab.@global[0].anon_mount=1
uci commit fstab

rm -f /www/luci-static/resources/view/status/include/50_dsl.js
rm -f /www/luci-static/resources/view/status/include/70_ddns.js
rm -f /www/luci-static/resources/view/status/include/80_minidlna.js
rm -f /www/luci-static/resources/view/status/include/80_upnp.js

ln -sf /sbin/ip /usr/bin/ip

sed -i '/log-facility/d' /etc/dnsmasq.conf
echo "log-facility=/dev/null" >> /etc/dnsmasq.conf

rm -rf /tmp/luci-modulecache/
rm -f /tmp/luci-indexcache

chmod +x /etc/init.d/turboacc_fss

echo '#!/bin/ash' > /tmp/wifi_transition_workaround.sh
echo 'function flush() {' >> /tmp/wifi_transition_workaround.sh
echo 'ssdk_sh fdb entry flush 1' >> /tmp/wifi_transition_workaround.sh
echo '}' >> /tmp/wifi_transition_workaround.sh
echo "IFS=$'\n'" >> /tmp/wifi_transition_workaround.sh
echo 'logread -f | while read line; do'  >> /tmp/wifi_transition_workaround.sh
echo 'if [[ "$line" == *"AP-STA-"* ]]; then' >> /tmp/wifi_transition_workaround.sh
echo 'flush </dev/null >/dev/null 2>&1' >> /tmp/wifi_transition_workaround.sh
echo 'fi'  >> /tmp/wifi_transition_workaround.sh
echo 'done'  >> /tmp/wifi_transition_workaround.sh
echo 'exit 0'  >> /tmp/wifi_transition_workaround.sh
chmod 777 /tmp/wifi_transition_workaround.sh

 /tmp/wifi_transition_workaround.sh &

exit 0
